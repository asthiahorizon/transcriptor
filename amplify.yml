version: 1
frontend:
  phases:
    preBuild:
      commands:
        - cd frontend
        - yarn install
    build:
      commands:
        - yarn build
  artifacts:
    baseDirectory: frontend/build
    files:
      - '**/*'
  cache:
    paths:
      - frontend/node_modules/**/*

backend:
  phases:
    preBuild:
      commands:
        # Install FFmpeg static binary (using git release, .tar.gz format)
        - curl -L https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz -o ffmpeg.tar.xz || curl -L https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip -o ffmpeg.zip
        - |
          if [ -f ffmpeg.tar.xz ]; then
            yum install -y xz || amazon-linux-extras install -y epel && yum install -y xz
            tar -xf ffmpeg.tar.xz
            mv ffmpeg-*/bin/ffmpeg ./ffmpeg
            mv ffmpeg-*/bin/ffprobe ./ffprobe
          elif [ -f ffmpeg.zip ]; then
            unzip -q ffmpeg.zip
            mv ffmpeg-*/bin/ffmpeg.exe ./ffmpeg 2>/dev/null || mv ffmpeg-*/bin/ffmpeg ./ffmpeg
            mv ffmpeg-*/bin/ffprobe.exe ./ffprobe 2>/dev/null || mv ffmpeg-*/bin/ffprobe ./ffprobe
          fi
        - chmod +x ./ffmpeg ./ffprobe
        - export PATH=$PWD:$PATH
        - cd backend
        - pip install -r requirements.txt
    build:
      commands:
        - echo "Backend build complete"
        - echo "FFmpeg location:" && which ffmpeg || echo "./ffmpeg"
  artifacts:
    baseDirectory: backend
    files:
      - '**/*'
      - '../ffmpeg'
      - '../ffprobe'
